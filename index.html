<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H…ôft…ôlik Planlama ‚Äî Front‚ÄëOnly (GitHub JSON + Secure Local Cache)</title>
  <style>
    :root{ --card:#ffffff; --muted:#475569; --brand:#4f46e5; --ring:rgba(79,70,229,.25); --text:#0f172a; --border:#e5e7eb }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background:linear-gradient(135deg,#74ebd5 0%, #9face6 100%); padding:clamp(12px,2.5vw,24px); display:flex; align-items:center; justify-content:center; color:var(--text) }
    .app{ width:min(1200px,100%) }
    .shell{ background:var(--card); border-radius:16px; box-shadow:0 20px 40px rgba(2,6,23,.15); overflow:hidden; border:1px solid var(--border) }

    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:clamp(12px,2vw,18px); border-bottom:1px solid var(--border); flex-wrap:wrap }
    .title{ font-weight:800; font-size:clamp(18px,2.4vw,24px); letter-spacing:.2px; display:flex; gap:8px; align-items:center }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .btn{ appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; line-height:1; transition:.2s box-shadow,.2s transform }
    .btn:hover{ box-shadow:0 0 0 4px var(--ring) }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
    .btn.ghost{ background:transparent }
    .btn.icon{ width:40px; height:40px; display:grid; place-items:center; padding:0; border-radius:999px }
    .week-meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-weight:600 }
    .badge{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#f8fafc; color:#0b3b69 }

    .notice{ padding:10px 14px; margin:12px 16px 0; border:1px dashed var(--border); border-radius:10px; color:#0b3b69; background:#f0f9ff; display:flex; gap:8px; align-items:center }

    .slider{ position:relative }
    .track{ display:flex; gap:12px; padding:clamp(10px,1.8vw,18px); overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch }
    .track::-webkit-scrollbar{ height:10px } .track::-webkit-scrollbar-thumb{ background:#e5e7eb; border-radius:999px }
    .nav{ position:absolute; top:50%; transform:translateY(-50%); z-index:5 }
    .nav.left{ left:8px } .nav.right{ right:8px }
    .nav .btn{ border-radius:999px; padding:10px 12px; box-shadow:0 6px 20px rgba(2,6,23,.15); backdrop-filter:blur(6px) }

    .day{ border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; min-height:220px; min-width:min(92vw,360px); scroll-snap-align:start; background:#fff }
    @media (min-width:640px){ .day{ min-width:360px } }
    @media (min-width:1024px){ .day{ min-width:380px } }
    .day-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px }
    .day h3{ margin:0; font-size:clamp(14px,1.5vw,16px); color:#111827; font-weight:800 }
    .day .date{ color:var(--muted); font-size:12px; font-weight:600 }
    .tasks{ display:flex; flex-direction:column; gap:8px; margin-top:6px; flex:1; min-height:48px }
    .task{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border:1px dashed var(--border); border-radius:10px; background:#fff; min-height:40px }
    .task.done{ opacity:.9; text-decoration:line-through; background:#f0fdf4; border-style:solid; border-color:#bbf7d0 }
    .task-left{ display:flex; align-items:center; gap:8px; min-width:0 }
    .task input[type="checkbox"]{ width:18px; height:18px }
    .task-title{ font-size:14px; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100% }
    .task-actions{ display:flex; gap:6px; flex-wrap:wrap }
    .add-inline{ display:flex; gap:6px; margin-top:8px; align-items:center }
    .add-inline input{ flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
    .add-inline button{ padding:10px 12px }
    .empty{ color:var(--muted); font-size:13px; text-align:center; padding:12px; border:1px dashed var(--border); border-radius:10px }
    .footer{ padding:12px 18px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; gap:8px; flex-wrap:wrap }
    .kbd{ padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#f8fafc; font-size:12px }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell" aria-label="H…ôft…ôlik planlama t…ôtbiqi">
      <div class="topbar">
        <div class="title" aria-live="polite">üìÖ H…ôft…ôlik Planlama</div>
        <div class="controls">
          <button class="btn" id="prevWeek" aria-label="∆èvv…ôlki h…ôft…ô">‚Üê ∆èvv…ôlki</button>
          <div class="week-meta"><span id="weekLabel">‚Äî</span></div>
          <button class="btn" id="nextWeek" aria-label="N√∂vb…ôti h…ôft…ô">N√∂vb…ôti ‚Üí</button>
          <button class="btn primary" id="todayBtn">Bu h…ôft…ô</button>
          <button class="btn" id="refreshBtn" title="GitHub-dan yenil…ô">‚ü≥ Yenil…ô</button>
          <span id="statusBadge" class="badge" title="Yadda≈ü rejimi">Read-only</span>
          <button class="btn ghost" id="authBtn" title="GitHub token / repo konfiqurasiya">GitHub Ayarlarƒ±</button>
        </div>
      </div>

      <div id="notice" class="notice" hidden>
        <strong>‚ÑπÔ∏è</strong>
        <span>Hazƒ±rda <b>read-only</b> rejimd…ôdir. Yazmaq √º√ß√ºn GitHub ayarlarƒ±nƒ± bir d…ôf…ô daxil et ‚Äî token v…ô repo parametrl…ôri <b>yerli ≈üifr…ôli ke≈üd…ô</b> saxlanacaq.</span>
      </div>

      <div class="slider">
        <div class="nav left"><button class="btn icon" id="slideLeft" title="Geri (‚óÄ)">‚óÄ</button></div>
        <div class="nav right"><button class="btn icon" id="slideRight" title="ƒ∞r…ôli (‚ñ∂)">‚ñ∂</button></div>
        <div class="track" id="track" aria-label="H…ôft…ônin g√ºnl…ôri" tabindex="0"></div>
      </div>

      <div class="footer">
        <span>M…ôlumatlar <b>GitHub</b>-dakƒ± <code>base.json</code> faylƒ±nda saxlanƒ±lƒ±r ‚Äî qlobal, cihazlararasƒ±, backend-siz. Konfiqurasiya <b>≈üifr…ôli local cache</b>-d…ô bir d…ôf…ô saxlanƒ±lƒ±r.</span>
        <span>Klaviatura: <span class="kbd">‚óÄ</span>/<span class="kbd">‚ñ∂</span></span>
      </div>
    </div>
  </div>

  <!-- Ayar modalƒ± -->
  <dialog id="tokenModal" class="modal">
    <form method="dialog" class="modal-card" id="settingsForm">
      <div class="modal-head">
        <strong>GitHub Ayarlarƒ±</strong>
        <button class="btn" value="close">Baƒüla</button>
      </div>
      <div class="modal-body">
        <label>
          <div class="help">Owner (istifad…ô√ßi v…ô ya t…ô≈ükilat)</div>
          <input id="ghOwner" class="input" placeholder="misal: camalcavadov" required />
        </label>
        <label>
          <div class="help">Repo (publik)</div>
          <input id="ghRepo" class="input" placeholder="misal: weekly-planner-data" required />
        </label>
        <label>
          <div class="help">Fayl yolu</div>
          <input id="ghPath" class="input" value="base.json" required />
        </label>
        <label>
          <div class="help">Branch</div>
          <input id="ghBranch" class="input" value="main" required />
        </label>
        <label>
          <div class="help">Personal Access Token (scope: <code>public_repo</code>)</div>
          <input id="ghToken" class="input" type="password" placeholder="ghp_..." required />
        </label>
        <div class="help">Token v…ô ayarlar <b>≈üifr…ôl…ônmi≈ü olaraq</b> localStorage-d…ô saxlanacaq ki, n√∂vb…ôti giri≈üd…ô yenid…ôn ist…ônm…ôsin. ƒ∞st…ôs…ôn sil…ô bil…ôrs…ôn.</div>
        <div style="display:flex; gap:8px; margin-top:6px">
          <button id="saveToken" class="btn primary">Yadda saxla</button>
          <button class="btn" value="close">L…ôƒüv et</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // ================== LOCAL SECURE CACHE (Crypto + localStorage) ==================
    // Sadelik √º√ß√ºn Web Crypto il…ô token/parametrl…ôri ≈üifr…ôl…ôyib localStorage-d…ô saxlayƒ±rƒ±q.
    // Bu, cihazda qalƒ±r; ist…ôs…ôn T…ômizl…ô d√ºym…ôsi il…ô sil…ô bil…ôrs…ôn.

    const LS_KEY = 'planner.enc.v1';
    const ENC_SALT = 'planner-static-salt-v1'; // production-da d…ôyi≈üm…ôk olar

    async function getKey(pass){
      const enc = new TextEncoder();
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name:'PBKDF2', salt:new TextEncoder().encode(ENC_SALT), iterations:100_000, hash:'SHA-256' },
        baseKey,
        { name:'AES-GCM', length:256 },
        false,
        ['encrypt','decrypt']
      );
    }

    async function encryptJSON(obj){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKey(location.host); // host-a baƒülƒ± a√ßar
      const data = new TextEncoder().encode(JSON.stringify(obj));
      const buf = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
      const out = new Uint8Array(iv.byteLength + buf.byteLength);
      out.set(iv,0); out.set(new Uint8Array(buf), iv.byteLength);
      return btoa(String.fromCharCode(...out));
    }
    async function decryptJSON(b64){
      const raw = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
      const iv = raw.slice(0,12); const data = raw.slice(12);
      const key = await getKey(location.host);
      const buf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
      return JSON.parse(new TextDecoder().decode(new Uint8Array(buf)));
    }

    async function cacheSave(cfg){ localStorage.setItem(LS_KEY, await encryptJSON(cfg)); }
    async function cacheLoad(){ const v = localStorage.getItem(LS_KEY); if(!v) return null; try{ return await decryptJSON(v) }catch{ return null } }
    function cacheClear(){ localStorage.removeItem(LS_KEY) }

    // ================== KONFƒ∞Q + STATE ==================
    let CONFIG = { owner:'', repo:'', path:'base.json', branch:'main', token:'' };
    let FILE_SHA = null; // GitHub faylƒ±nƒ±n son sha-sƒ±

    const statusBadge = document.getElementById('statusBadge');
    const notice = document.getElementById('notice');
    const authBtn = document.getElementById('authBtn');
    const tokenModal = document.getElementById('tokenModal');
    const refreshBtn = document.getElementById('refreshBtn');

    function setMode(writeable){
      statusBadge.textContent = writeable ? 'Write-enabled' : 'Read-only';
      statusBadge.style.color = writeable ? '#065f46' : '#0b3b69';
      statusBadge.style.background = writeable ? '#ecfdf5' : '#f0f9ff';
      notice.hidden = writeable;
    }

    authBtn.onclick = async ()=>{
      // Modalƒ± a√ß v…ô local cache-d…ôn doldur
      const data = await cacheLoad();
      if(data){
        document.getElementById('ghOwner').value = data.owner||'';
        document.getElementById('ghRepo').value  = data.repo||'';
        document.getElementById('ghPath').value  = data.path||'base.json';
        document.getElementById('ghBranch').value= data.branch||'main';
        document.getElementById('ghToken').value = data.token||'';
      }
      tokenModal.showModal();
    };

    document.getElementById('saveToken').onclick = async (e)=>{
      e.preventDefault();
      CONFIG.owner  = document.getElementById('ghOwner').value.trim();
      CONFIG.repo   = document.getElementById('ghRepo').value.trim();
      CONFIG.path   = document.getElementById('ghPath').value.trim()||'base.json';
      CONFIG.branch = document.getElementById('ghBranch').value.trim()||'main';
      CONFIG.token  = document.getElementById('ghToken').value.trim();
      if(!CONFIG.owner||!CONFIG.repo||!CONFIG.token){ alert('Owner, repo v…ô token t…ôl…ôb olunur.'); return; }
      await cacheSave(CONFIG); // ≈üifr…ôli saxla
      setMode(true);
      tokenModal.close();
      await ghSyncInit();
    };

    refreshBtn.onclick = async ()=>{ await ghLoad(); await render(); };

    // ================== GITHUB API HELPERS ==================
    const API = {
      base(owner,repo){ return `https://api.github.com/repos/${owner}/${repo}`; },
      contents(owner,repo,path){ return `${API.base(owner,repo)}/contents/${encodeURIComponent(path)}`; }
    };
    function b64e(str){ return btoa(unescape(encodeURIComponent(str))) }
    function b64d(str){ return decodeURIComponent(escape(atob(str))) }

    async function ghLoad(){
      const url = API.contents(CONFIG.owner, CONFIG.repo, CONFIG.path) + `?ref=${encodeURIComponent(CONFIG.branch)}`;
      const r = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' } });
      if(r.status===404){ FILE_SHA=null; STORE={}; return; }
      if(!r.ok) throw new Error('GitHub read_failed');
      const data = await r.json(); FILE_SHA = data.sha || null;
      const decoded = data.content ? b64d(data.content.replace(/\n/g,'')) : '{}';
      try{ STORE = JSON.parse(decoded||'{}'); }catch{ STORE = {}; }
    }

    async function ghSave(obj, message='update plans'){
      if(!CONFIG.token) throw new Error('no_token');
      const url = API.contents(CONFIG.owner, CONFIG.repo, CONFIG.path);
      const body = { message, content: b64e(JSON.stringify(obj, null, 2)), branch: CONFIG.branch };
      if(FILE_SHA) body.sha = FILE_SHA;
      const r = await fetch(url, { method:'PUT', headers:{ 'Accept':'application/vnd.github+json', 'Content-Type':'application/json', 'Authorization':`Bearer ${CONFIG.token}` }, body: JSON.stringify(body) });
      if(!r.ok){ const txt=await r.text().catch(()=>""); throw new Error('GitHub write_failed: '+txt); }
      const out = await r.json(); FILE_SHA = out.content?.sha || FILE_SHA; return true;
    }

    // ================== TARƒ∞X/STATE/UI ==================
    function keyFor(y,w){ return `${y}-W${String(w).padStart(2,'0')}` }
    function readWeekObj(y,w){ return STORE[keyFor(y,w)] || {} }
    function writeWeekObj(y,w,weekData){ STORE[keyFor(y,w)] = weekData }

    let STORE = {}; // RAM
    let current = getISOWeekDate(new Date());

    const track = document.getElementById('track');
    const weekLabel = document.getElementById('weekLabel');
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const todayBtn = document.getElementById('todayBtn');
    const slideLeftBtn = document.getElementById('slideLeft');
    const slideRightBtn = document.getElementById('slideRight');

    prevWeekBtn.onclick=()=>shiftWeek(-1);
    nextWeekBtn.onclick=()=>shiftWeek(1);
    todayBtn.onclick=()=>{ current=getISOWeekDate(new Date()); render() };
    slideLeftBtn.onclick=()=>slide(-1);
    slideRightBtn.onclick=()=>slide(1);
    track.addEventListener('wheel',(e)=>{ if(Math.abs(e.deltaX)<Math.abs(e.deltaY)) return; e.preventDefault(); track.scrollLeft+=e.deltaX },{passive:false});
    document.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') slide(-1); if(e.key==='ArrowRight') slide(1); });

    async function ghSyncInit(){ try{ await ghLoad(); await render(); }catch(e){ console.error(e); alert('GitHub-dan oxuma alƒ±nmadƒ±. Parametrl…ôri yoxla.'); } }

    async function shiftWeek(delta){ const monday=startOfISOWeek(current.year,current.week); const nextMon=addDays(monday,delta*7); current=getISOWeekDate(nextMon); await render() }

    async function render(){
      const monday=startOfISOWeek(current.year,current.week);
      weekLabel.textContent=`${current.year} ¬∑ ${current.week}-ci h…ôft…ô (${fmtDate(monday)} ‚Äì ${fmtDate(addDays(monday,6))})`;
      track.innerHTML='';
      const weekData=readWeekObj(current.year,current.week);

      for(let i=0;i<7;i++){
        const dayDate=addDays(monday,i);
        const tasks=Array.isArray(weekData[i])?weekData[i]:[];
        const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.dataset.dayIndex=i;
        dayEl.innerHTML=`
          <div class="day-header">
            <div>
              <h3>${['Bazar ert…ôsi','√á…ôr≈ü…ônb…ô ax≈üamƒ±','√á…ôr≈ü…ônb…ô','C√ºm…ô ax≈üamƒ±','C√ºm…ô','≈û…ônb…ô','Bazar'][i]}</h3>
              <div class="date">${fmtDate(dayDate)}</div>
            </div>
            <button class="btn" data-action="toggle-add" aria-label="Plan …ôlav…ô et">+ Plan</button>
          </div>
          <div class="tasks" role="list">
            ${tasks.length?tasks.map((t,idx)=>`
              <div class="task ${t.done?'done':''}" data-idx="${idx}" role="listitem">
                <div class="task-left">
                  <input type="checkbox" ${t.done?'checked':''} data-action="toggle-done" aria-label="Tamamlandƒ±" />
                  <div class="task-title" title="${t.text.replace(/"/g,'&quot;')}">${t.text}</div>
                </div>
                <div class="task-actions">
                  <button class="btn" data-action="edit">D…ôyi≈ü</button>
                  <button class="btn" data-action="delete">Sil</button>
                </div>
              </div>
            `).join(''):`<div class="empty">He√ß bir plan yoxdur</div>`}
          </div>
          <div class="add-inline" hidden>
            <input type="text" placeholder="Plan m…ôtni..." aria-label="Plan m…ôtni" />
            <button class="btn primary" data-action="add">∆èlav…ô et</button>
            <button class="btn" data-action="cancel">Baƒüla</button>
          </div>`;
        track.appendChild(dayEl);
      }

      attachHandlers(); requestAnimationFrame(()=>scrollToCard(0));
    }

    function attachHandlers(){
      track.querySelectorAll('.day').forEach(day=>{
        day.addEventListener('click', async (e)=>{
          const action=e.target?.dataset?.action; if(!action) return; e.preventDefault();
          const dayIndex=Number(day.dataset.dayIndex);
          if(action==='toggle-add') return toggleAdd(day);
          if(action==='cancel') return toggleAdd(day,true);
          if(action==='add'){
            if(!CONFIG.token){ alert('GitHub ayarlarƒ±nƒ± doldur.'); return; }
            const input=day.querySelector('.add-inline input'); const txt=input.value.trim(); if(!txt) return;
            const data=readWeekObj(current.year,current.week); if(!Array.isArray(data[dayIndex])) data[dayIndex]=[];
            data[dayIndex].push({text:txt,done:false,ts:Date.now()}); writeWeekObj(current.year,current.week,data);
            try{ await ghSave(STORE,'add task'); await ghLoad(); await render(); }catch(err){ alert('Yazma x…ôtasƒ±: '+err.message) }
            return;
          }
          const idx=getTaskIndex(e.target); if(idx<0) return;
          if(action==='toggle-done'){
            if(!CONFIG.token){ alert('GitHub ayarlarƒ±nƒ± doldur.'); return; }
            const data=readWeekObj(current.year,current.week); data[dayIndex][idx].done=!data[dayIndex][idx].done; writeWeekObj(current.year,current.week,data);
            try{ await ghSave(STORE,'toggle done'); await ghLoad(); await render(); }catch(err){ alert('Yazma x…ôtasƒ±: '+err.message) }
            return;
          }
          if(action==='delete'){
            if(!CONFIG.token){ alert('GitHub ayarlarƒ±nƒ± doldur.'); return; }
            const data=readWeekObj(current.year,current.week); data[dayIndex].splice(idx,1); writeWeekObj(current.year,current.week,data);
            try{ await ghSave(STORE,'delete task'); await ghLoad(); await render(); }catch(err){ alert('Yazma x…ôtasƒ±: '+err.message) }
            return;
          }
          if(action==='edit'){
            if(!CONFIG.token){ alert('GitHub ayarlarƒ±nƒ± doldur.'); return; }
            const data=readWeekObj(current.year,current.week); const t=data[dayIndex][idx];
            const nv=prompt('Yeni m…ôtni daxil edin:', t.text); if(nv===null) return; const v=nv.trim(); if(!v) return; t.text=v; writeWeekObj(current.year,current.week,data);
            try{ await ghSave(STORE,'edit task'); await ghLoad(); await render(); }catch(err){ alert('Yazma x…ôtasƒ±: '+err.message) }
            return;
          }
        });
      });
    }

    function toggleAdd(dayEl,close=false){ const box=dayEl.querySelector('.add-inline'); if(close){ box.hidden=true; return } box.hidden=!box.hidden; if(!box.hidden){ const inp=box.querySelector('input'); inp.value=''; inp.focus() } }
    function getTaskIndex(el){ return Number(el.closest('.task')?.dataset?.idx||-1) }

    // Slider helpers
    function getCardWidth(){ const first=track.querySelector('.day'); if(!first) return 360; const rect=first.getBoundingClientRect(); const gap=parseFloat(getComputedStyle(track).gap||12); return rect.width+gap }
    function scrollToCard(index){ const cardW=getCardWidth(); track.scrollTo({ left:index*cardW, behavior:'smooth' }) }
    function visibleIndex(){ const cardW=getCardWidth(); return Math.round(track.scrollLeft/cardW) }
    function slide(dir){ const next=Math.min(6,Math.max(0,visibleIndex()+dir)); scrollToCard(next) }

    // Bootstrap: cache‚Äëd…ôn oxu ‚Üí GitHub‚Äëdan y√ºkl…ô ‚Üí render
    (async function init(){
      const c = await cacheLoad();
      if(c){ CONFIG = c; setMode(!!CONFIG.token); }
      try{ if(CONFIG.owner && CONFIG.repo) await ghLoad(); }catch(e){ console.warn(e) }
      await render();
    })();
  </script>
</body>
</html>
